<html>

<head>
  <script id="digits-sdk" src="https://cdn.digits.com/1/sdk.js" async></script>
  <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBP5EaFCQ0yAbcvYozyKCwKJ2Wf-yioCs4",
      authDomain: "quiver-two.firebaseapp.com",
      databaseURL: "https://quiver-two.firebaseio.com",
      storageBucket: "quiver-two.appspot.com",
    };
    firebase.initializeApp(config);
  </script>
</head>

<body>
  <button onclick="logIn()">Log In</button>
  <script>
    /* Initialize Digits for Web using your application's consumer key that Fabric generated */
    document.getElementById('digits-sdk').onload = function() {
      Digits.init({ consumerKey: 'P9yPbzXusrtrWYUVFDmepZYOq' });
    };

    var ref = firebase.database().ref('digits');
    function logIn() {
      Digits.logIn()
        .done(function(res) {
          var headersString = res.oauth_echo_headers['X-Verify-Credentials-Authorization'];
          var headers = headersString.match(/\S+=[^\s|^,]+/g).reduce(function (prev, curr) {
            var matches = curr.match(/(\S+)="(\S+)"/);
            prev[matches[1]] = matches[2];
            return prev;
          }, {});
          var loginRef = ref.child(`login/${headers.oauth_token}`);
          loginRef.set(headers)
            .then(function () {
              return loginRef.once('child_changed');
            })
            .then(function (snap) {
              console.log(snap.val());
              debugger;
            })
            .catch(function (err) {
              console.log('firebase error', err);
            });
        })
        .fail(function(err) {
          console.log('Digits login fail', err);
        });
    };
  </script>
</body>

</html>